<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>surveytidy Package Development • surveytidy</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/Roboto-0.4.10/font.css" rel="stylesheet"><link href="deps/Inter-0.4.10/font.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="surveytidy Package Development"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-#e5f3f7" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">surveytidy</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="external-link nav-link" href="https://github.com/JDenn0514/surveytidy"><span class="fa fab fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>surveytidy Package Development</h1>
      <small class="dont-index">Source: <a href="https://github.com/JDenn0514/surveytidy/blob/main/CLAUDE.md" class="external-link"><code>CLAUDE.md</code></a></small>
    </div>

<div id="surveytidy-package-development" class="section level1">

<p><strong>Part of the <a href="../survey-standards/ECOSYSTEM.html">surveyverse ecosystem</a> — see there for ecosystem vision, architecture, and how surveytidy relates to other packages.</strong></p>
<hr><div class="section level2">
<h2 id="project-overview">Project Overview<a class="anchor" aria-label="anchor" href="#project-overview"></a></h2>
<p>surveytidy provides dplyr/tidyr verbs for survey design objects from surveycore. It extends tidyverse workflows to work seamlessly with complex survey designs, allowing users to filter, select, mutate, and group survey objects while maintaining proper variance estimation and metadata handling.</p>
</div>
<div class="section level2">
<h2 id="package-information">Package Information<a class="anchor" aria-label="anchor" href="#package-information"></a></h2>
<ul><li>
<strong>Name:</strong> surveytidy</li>
<li>
<strong>Purpose:</strong> dplyr/tidyr verbs for survey objects (filter, select, mutate, rename, arrange, group_by, etc.)</li>
<li>
<strong>Target Audience:</strong> Survey researchers using tidyverse; users transitioning from srvyr</li>
<li>
<strong>Current Status:</strong> Phase 0.5 (planning complete; implementation starting)</li>
<li>
<strong>License:</strong> GPL-3 (inherits from surveycore)</li>
<li>
<strong>Dependencies:</strong> surveycore (imports core S7 classes)</li>
</ul></div>
<div class="section level2">
<h2 id="vision--goals">Vision &amp; Goals<a class="anchor" aria-label="anchor" href="#vision--goals"></a></h2>
<p>surveytidy makes survey analysis feel natural to tidyverse users by:</p>
<ol style="list-style-type: decimal"><li>
<strong>Domain-aware filtering</strong> — <code><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter()</a></code> marks rows in/out of domain without removing them</li>
<li>
<strong>Intelligent metadata handling</strong> — <code>select()</code> and <code>rename()</code> update labels automatically</li>
<li>
<strong>Group-by support</strong> — <code>group_by()</code> sets up stratification for Phase 1 estimation functions</li>
<li>
<strong>Familiar API</strong> — Users never write formula syntax; everything uses bare names (tidy-select)</li>
</ol></div>
<div class="section level2">
<h2 id="key-design-decisions-finalized">Key Design Decisions (Finalized)<a class="anchor" aria-label="anchor" href="#key-design-decisions-finalized"></a></h2>
<ul><li>
<strong>dplyr verbs map to survey concepts</strong> — filter = domain, select = simplify data (remove non-design cols), mutate = add variables</li>
<li>
<strong>Metadata travels with data</strong> — All verbs update <code>@variables</code> and <code>@metadata</code> keys</li>
<li>
<strong>Filter preserves all rows</strong> — Uses domain column internally; never removes rows</li>
<li>
<strong>No formula syntax</strong> — Always <code>filter(design, age &gt; 65)</code>, never <code>filter(design, ~age &gt; 65)</code>
</li>
<li>
<strong>S3 dispatch via registerS3method()</strong> — Not S7 methods; dplyr’s S3 dispatch works for all survey classes</li>
</ul></div>
<div class="section level2">
<h2 id="dplyr-dispatch-pattern-critical">dplyr Dispatch Pattern (CRITICAL)<a class="anchor" aria-label="anchor" href="#dplyr-dispatch-pattern-critical"></a></h2>
<p>S7 namespaced class names break S3 dispatch. To make dplyr verbs work:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># In .onLoad():</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html" class="external-link">registerS3method</a></span><span class="op">(</span></span>
<span>  <span class="st">"filter"</span>, <span class="st">"surveycore::survey_base"</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="st">"filter.survey_base"</span>, envir <span class="op">=</span> <span class="va">ns</span><span class="op">)</span>,</span>
<span>  envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html" class="external-link">asNamespace</a></span><span class="op">(</span><span class="st">"dplyr"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This registers the S3 method with dplyr’s environment so dispatch works.</p>
<p>See <code>R/00-zzz.R</code> for full setup.</p>
</div>
<div class="section level2">
<h2 id="architecture">Architecture<a class="anchor" aria-label="anchor" href="#architecture"></a></h2>
<div class="section level3">
<h3 id="file-organization-r">File Organization (R/)<a class="anchor" aria-label="anchor" href="#file-organization-r"></a></h3>
<pre><code>R/
├── 00-zzz.R                # .onLoad(): S3 method registration + S7::methods_register()
├── 01-filter.R             # filter.survey_base, dplyr_reconstruct.survey_base
├── 02-select.R             # select.survey_base, pull.survey_base, glimpse.survey_base
├── 03-mutate.R             # mutate.survey_base (warns on weight column modification)
├── 04-rename.R             # rename.survey_base (auto-updates @variables + @metadata keys)
├── 05-arrange.R            # arrange.survey_base, slice_*.survey_base
├── 06-group-by.R           # group_by.survey_base, ungroup.survey_base
├── 07-tidyr.R              # drop_na(), separate_*(), unite() (stretch goals)
├── 08-joins.R              # *_join() (stretch goals)
└── surveytidy-package.R    # Package-level documentation + @importFrom dplyr</code></pre>
</div>
<div class="section level3">
<h3 id="test-organization-teststestthat">Test Organization (tests/testthat/)<a class="anchor" aria-label="anchor" href="#test-organization-teststestthat"></a></h3>
<pre><code>tests/testthat/
├── helper-test-data.R      # Shared test data generators (copied from surveycore)
├── test-filter.R           # filter() and related domain operations
├── test-select.R           # select(), pull(), glimpse()
├── test-mutate.R           # mutate() behavior + weight column warnings
├── test-rename.R           # rename() + automatic metadata updates
├── test-arrange.R          # arrange(), slice_*()
├── test-group-by.R         # group_by(), ungroup()
└── test-tidyr.R            # tidyr functions (drop_na, separate, unite)</code></pre>
</div>
<div class="section level3">
<h3 id="key-concepts">Key Concepts<a class="anchor" aria-label="anchor" href="#key-concepts"></a></h3>
<div class="section level4">
<h4 id="domain-column">Domain Column<a class="anchor" aria-label="anchor" href="#domain-column"></a></h4>
<ul><li>Name: <code>"..surveycore_domain.."</code> (use <code><a href="https://jdenn0514.github.io/surveycore/reference/SURVEYCORE_DOMAIN_COL.html" class="external-link">surveycore::SURVEYCORE_DOMAIN_COL</a></code>)</li>
<li>Type: logical column in <code>@data</code>
</li>
<li>Content: TRUE for in-domain rows, FALSE for out-of-domain rows</li>
<li>Never removed; only created/updated by <code><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter()</a></code>
</li>
</ul></div>
<div class="section level4">
<h4 id="visible_vars">visible_vars<a class="anchor" aria-label="anchor" href="#visible_vars"></a></h4>
<ul><li>Key in <code>@variables$visible_vars</code>
</li>
<li>Set by <code>select()</code> to the user’s explicit column selection</li>
<li>Controls which columns <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> shows (hides design vars from display)</li>
<li>NULL means all columns in <code>@data</code> are shown (default)</li>
<li>After <code>select()</code>, <code>@data</code> only contains design vars + user-selected cols; <code>visible_vars</code> tracks the user’s selection so design vars are hidden from print</li>
</ul></div>
<div class="section level4">
<h4 id="groups">@groups<a class="anchor" aria-label="anchor" href="#groups"></a></h4>
<ul><li>Reserved for Phase 0.5 (now used by <code>group_by()</code>)</li>
<li>Populated by <code>group_by()</code>, cleared by <code>ungroup()</code>
</li>
<li>Will be used by Phase 1 estimation functions</li>
</ul></div>
<div class="section level4">
<h4 id="dplyr_reconstruct">dplyr_reconstruct()<a class="anchor" aria-label="anchor" href="#dplyr_reconstruct"></a></h4>
<ul><li>Required for complex pipelines (joins, across(), slice, etc.)</li>
<li>Rebuilds survey class from reconstructed <code>data</code> + original template</li>
<li>Errors if design variables are removed</li>
</ul></div>
</div>
</div>
<div class="section level2">
<h2 id="before-starting-any-implementation">Before Starting Any Implementation<a class="anchor" aria-label="anchor" href="#before-starting-any-implementation"></a></h2>
<p><strong>Read these files first — in this order — before writing any code:</strong></p>
<p><strong>Shared standards (all surveyverse packages follow these):</strong> 1. <code>../survey-standards/.claude/rules/code-style.md</code> — indentation, S7 method syntax, error conventions, function design 2. <code>../survey-standards/.claude/rules/testing-standards.md</code> — test structure, coverage requirements, assertion patterns 3. <code>../survey-standards/.claude/rules/r-package-conventions.md</code> — roxygen2, NAMESPACE, exports, R CMD check hygiene 4. <code>../survey-standards/.claude/rules/github-strategy.md</code> — branching model, commit format, PR workflow 5. <code>../survey-standards/.claude/rules/changelog-workflow.md</code> — changelog entries (required before every PR) and decisions log (required after plan mode)</p>
<p><strong>Package-specific (surveytidy only):</strong> - <code>.claude/rules/</code> — any package-specific rules or extensions</p>
<p><strong>Then reference:</strong> - <code>../surveycore/CLAUDE.md</code> — for surveycore architecture (survey class structure, @data/@variables/@metadata) - <code>../surveycore/plans/</code> — error-messages.md, formal spec, implementation plan</p>
</div>
<div class="section level2">
<h2 id="phase-05-build-order">Phase 0.5 Build Order<a class="anchor" aria-label="anchor" href="#phase-05-build-order"></a></h2>
<ol style="list-style-type: decimal"><li>
<code>feature/filter</code> — <code>R/01-filter.R</code> + <code>tests/testthat/test-filter.R</code>
</li>
<li>
<code>feature/select</code> — <code>R/02-select.R</code> + <code>tests/testthat/test-select.R</code>
</li>
<li>
<code>feature/mutate</code> — <code>R/03-mutate.R</code> + <code>tests/testthat/test-mutate.R</code>
</li>
<li>
<code>feature/rename</code> — <code>R/04-rename.R</code> + <code>tests/testthat/test-rename.R</code>
</li>
<li>
<code>feature/arrange</code> — <code>R/05-arrange.R</code> + <code>tests/testthat/test-arrange.R</code>
</li>
<li>
<code>feature/group-by</code> — <code>R/06-group-by.R</code> + <code>tests/testthat/test-group-by.R</code>
</li>
<li>
<code>feature/tidyr</code> — <code>R/07-tidyr.R</code> + <code>tests/testthat/test-tidyr.R</code> (stretch)</li>
<li>
<code>feature/joins</code> — <code>R/08-joins.R</code> + <code>tests/testthat/test-joins.R</code> (stretch)</li>
</ol><hr></div>
<div class="section level2">
<h2 id="key-implementation-details">Key Implementation Details<a class="anchor" aria-label="anchor" href="#key-implementation-details"></a></h2>
<div class="section level3">
<h3 id="filter-specifics">filter() Specifics<a class="anchor" aria-label="anchor" href="#filter-specifics"></a></h3>
<ul><li>Stores conditions in <code>@variables$domain</code> (list of quosures)</li>
<li>Chained filters AND the masks: <code>existing_domain &amp; new_mask</code>
</li>
<li>Empty domain (all FALSE) triggers <code>surveycore_warning_empty_domain</code>
</li>
<li>
<code>.by</code> argument not supported; raises <code>surveycore_error_filter_by_unsupported</code>
</li>
</ul></div>
<div class="section level3">
<h3 id="select-specifics">select() Specifics<a class="anchor" aria-label="anchor" href="#select-specifics"></a></h3>
<ul><li>
<strong>Physically removes</strong> non-selected, non-design columns from <code>@data</code>
</li>
<li>
<strong>Always keeps</strong> all design variables in <code>@data</code> (weights, strata, PSU, FPC, repweights, domain column) — they are required for variance estimation</li>
<li>Sets <code>@variables$visible_vars</code> to the user’s selection — this hides design vars from print output (they’re in <code>@data</code> but not in the user’s selection)</li>
<li>Normalises <code>visible_vars</code> to <code>NULL</code> when result is empty (e.g. user selects only design variables) — <code>NULL</code> means “show all columns in @data”</li>
<li>Deletes <code>@metadata</code> entries for physically removed columns only</li>
<li>
<code>select()</code> is irreversible within a pipeline: removed columns are gone</li>
</ul></div>
<div class="section level3">
<h3 id="rename-specifics">rename() Specifics<a class="anchor" aria-label="anchor" href="#rename-specifics"></a></h3>
<ul><li>Uses <code>surveycore:::.update_design_var_names()</code> to update @variables keys</li>
<li>Uses <code>surveycore:::.rename_metadata_keys()</code> to update @metadata keys</li>
<li>
<strong>Warns</strong> (does not error) if user renames a design variable; updates <code>@variables</code> to track the new column name (<code>surveytidy_warning_rename_design_var</code>)</li>
</ul></div>
<div class="section level3">
<h3 id="dplyr_reconstruct-1">dplyr_reconstruct()<a class="anchor" aria-label="anchor" href="#dplyr_reconstruct-1"></a></h3>
<ul><li>Called by dplyr for complex operations (joins, across(), slice, etc.)</li>
<li>Must rebuild survey class from <code>data</code> + <code>template</code>
</li>
<li>Errors with <code>surveycore_error_design_var_removed</code> if design cols deleted</li>
</ul></div>
<div class="section level3">
<h3 id="subsetsurvey_base">subset.survey_base<a class="anchor" aria-label="anchor" href="#subsetsurvey_base"></a></h3>
<ul><li>Physical subsetting (actually removes rows, unlike filter)</li>
<li>Always issues <code>surveycore_warning_physical_subset</code>
</li>
<li>Registered via NAMESPACE (base R generic, not dplyr)</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="working-with-this-codebase">Working With This Codebase<a class="anchor" aria-label="anchor" href="#working-with-this-codebase"></a></h2>
<ol style="list-style-type: decimal"><li>
<strong>Follow established patterns</strong> — consistency with surveycore matters</li>
<li>
<strong>Update metadata automatically</strong> — verbs should handle @variables/@metadata updates</li>
<li>
<strong>Test all combinations</strong> — each verb tested with all three design types (taylor, replicate, twophase)</li>
<li>
<strong>Check domain preservation</strong> — domain column should survive all operations intact</li>
<li>
<strong>Provide complete code blocks</strong> — ready to copy and use</li>
<li>
<strong>Include tests</strong> — always provide corresponding tests for new verbs</li>
</ol></div>
<div class="section level2">
<h2 id="reference-documents">Reference Documents<a class="anchor" aria-label="anchor" href="#reference-documents"></a></h2>
<p>All planning documents are in <code>plans/</code>: - (Currently minimal; will grow as Phase 0.5 proceeds)</p>
<p>All finalized decisions are in <code>../survey-standards/.claude/rules/</code>: - <code>code-style.md</code> — R style, S7 patterns, error conventions, function design - <code>testing-standards.md</code> — test structure, coverage, assertion patterns, test data - <code>r-package-conventions.md</code> — roxygen2, NAMESPACE, exports, R CMD check hygiene - <code>github-strategy.md</code> — branching, commits, PRs, CI/CD, release process</p>
<hr><p><strong>Always defer to surveycore’s CLAUDE.md for survey class internals. surveytidy is an add-on layer.</strong></p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jacob Dennen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

