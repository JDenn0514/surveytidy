# R Package Conventions (Surveyverse)

**Version:** 1.0
**Created:** February 2025
**Status:** Decided — applies to all surveyverse packages

This document covers conventions that apply to **all surveyverse R packages**. For package-specific examples and details, see the local conventions file in each package (e.g., `surveycore-conventions.md`).

---

## Quick Reference

| Decision | Choice |
|----------|--------|
| Import style | `::` everywhere; no `@importFrom` |
| `devtools::document()` | Before committing any file that changes roxygen2 content |
| `devtools::check()` | Before opening a PR |
| NAMESPACE edits | Never manual — 100% generated by `devtools::document()` |
| `R CMD check` | 0 errors, 0 warnings, ≤2 pre-approved notes |
| Export policy | User-facing functions + S7 classes only |
| Re-exports | None — no pipe, no tidyselect helpers |
| Internal function docs | `@keywords internal` + `@noRd` for complex helpers |
| `@return` | Required on all exported functions |
| `@examples` | All runnable — no `\dontrun{}` |
| Version pinning | Minimum versions only (e.g., `cli (>= 3.6.0)`) |

---

## 1. Documentation (Roxygen2)

### `@param` verbosity: variable by complexity

Write `@param` descriptions proportional to how non-obvious the argument is.

**Terse** (one sentence) for simple, self-evident arguments:
```r
#' @param data A data.frame.
#' @param label A character string.
#' @param ... Additional arguments (currently unused).
```

**Fuller** for arguments with non-obvious behavior, constraints, or interactions:
```r
#' @param weights <[`tidy-select`][tidyselect::language]> Column(s) for
#'   survey weights. If multiple columns, they are combined. Cannot contain
#'   `NA`. Default `NULL` (uniform weights).
```

Arguments that **always** get fuller treatment:
- Any argument that interacts with another argument (mutual exclusion, dependency)
- Arguments where `NULL` has non-obvious behavior
- Arguments that accept multiple interpretations
- Arguments with valid value constraints

### `@return` required on all exports

Every exported function must have `@return`. Write terse returns for obvious cases:

```r
#' @return A survey design object.
#' @return A data.frame of results.
#' @return A character string, or `NULL` if not set.
#' @return The modified object, invisibly.
```

### `@examples`: all runnable

Every example must run successfully during `R CMD check`. Do not use `\dontrun{}` except for examples that genuinely require external resources (e.g., live database connection).

If an example is slow, use a smaller inline dataset instead of `\dontrun{}`:

```r
#' @examples
#' # Small inline example (preferred)
#' df <- data.frame(id = 1:10, y = rnorm(10))
#' result <- my_function(df)
```

### `@family` grouping

Organize exported functions into families using `@family`:

```r
#' @family constructors
as_survey <- function(...) { ... }

#' @family selectors
select <- function(...) { ... }
```

See package-specific conventions for exact family definitions.

### Internal function documentation

| Helper complexity | Documentation |
|-------------------|---------------|
| Obvious one-liner | No roxygen at all |
| Complex enough to need explanation | `@keywords internal` + `@noRd` |

```r
# One-liner — no roxygen needed
.get_col <- function(x, col) x[[col]]

# Complex helper — document but suppress .Rd
#' Validate survey design structure
#'
#' @param x A survey design object.
#' @return Invisibly, `TRUE` on success (errors otherwise).
#' @keywords internal
#' @noRd
.validate_design <- function(x) { ... }
```

---

## 2. NAMESPACE & Exports

### Export policy: user-facing functions + S7 classes

Both **user-facing functions** and **S7 class objects** are exported. S7 classes are part of the documented API.

```r
# User-facing function — export with @export
#' @export
my_function <- function(...) { ... }

# S7 class — export with @export
#' @export
my_class <- S7::new_class("my_class", ...)
```

Unexported:
- All `.`-prefixed helpers (`.internal_fn()`)
- Internal S7 generics not part of public API

### `::` everywhere — no `@importFrom`

Call all external package functions with `::`. No `@importFrom` in any source file.

```r
# Correct
result <- rlang::enquo(x)
cli::cli_abort("message", class = "error_class")

# Wrong
result <- enquo(x)           # requires @importFrom rlang enquo
cli_abort("message")         # requires @importFrom cli cli_abort
```

**Why:** Maximally explicit about function origins. Namespace lookup overhead is negligible for R code (not the bottleneck).

### No re-exports

Do not re-export the pipe, tidyselect helpers, or other utility functions. Users who need them have tidyverse/rlang loaded.

```r
# Wrong — don't do this
#' @importFrom magrittr %>%
#' @export
`%>%` <- magrittr::`%>%`
```

### `NAMESPACE` is never manually edited

`NAMESPACE` carries the `# Generated by roxygen2: do not edit by hand` header. It is a build artifact.

**Every export, import, and S3 method registration must come from a roxygen2 tag.**

If roxygen2 can't express something, find a roxygen2 solution — do not work around it with manual edits.

---

## 3. Package Check Hygiene

### `R CMD check` targets

**All PRs must pass with:**
- 0 errors
- 0 warnings
- ≤2 notes (see approved notes below)

### Pre-approved notes

These two notes are acceptable and do not block merging:

| Note | Why it appears | Why it's accepted |
|------|----------------|-------------------|
| `no visible binding for global variable 'X'` | Tidy-select bare names | Universal in tidy packages |
| `checking CRAN incoming feasibility` | Package not on CRAN yet | Informational only |

Any other note is treated as a bug and blocks the PR.

### NSE "no visible binding" notes: accept, don't suppress

Do not suppress NSE notes with `utils::globalVariables()`. Do not change examples to use `.data$var` syntax.

The note is pre-approved. Accept it and move on.

### `devtools::check()` cadence

**Local development:**
```r
devtools::check()  # Fast feedback, no --as-cran flag
```

**CI (GitHub Actions):**
```yaml
args: 'c("--as-cran", "--no-manual")'
```

Switch to `--as-cran` locally only in Phase 3 (Polish) when CRAN submission is imminent.

### `devtools::document()` cadence

Run `devtools::document()` **before committing** any file that changes roxygen2 content:

```r
# Before committing changes to R/03-functions.R
devtools::document()
git add NAMESPACE man/my_function.Rd
git commit -m "docs(functions): update roxygen"
```

NAMESPACE and `man/` files are committed to version control and must be in sync with source.

### Minimum version pinning

Specify **lower bounds** for all `Imports` dependencies. Set the bound to the oldest version where the required feature exists.

```r
Imports:
    cli (>= 3.6.0),        # cli_abort() with class= argument
    rlang (>= 1.1.0),      # rlang::check_required()
    S7 (>= 0.1.0)          # S7 class system
Suggests:
    testthat (>= 3.0.0)
```

Do NOT use exact version pins (`==`). They are rejected by CRAN and too fragile.

---

## 4. Package Metadata

### DESCRIPTION fields

All surveyverse packages include:

```
Package: surveyXXX
Title: [Descriptive title matching the package role]
Version: 0.0.0.9000
Authors@R: person("Jacob", "Dennen", role = c("aut", "cre"), email = "...")
Description: [1-2 sentence description of what the package does]
License: GPL-3
Encoding: UTF-8
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.x.x
```

### Package documentation (surveypkg-package.R)

Every surveyverse package has a documented entry point:

```r
#' surveytidy: dplyr/tidyr verbs for survey objects
#'
#' @description
#' surveytidy provides dplyr and tidyr verbs that work with survey design objects
#' from surveycore, allowing...
#'
#' @section Key Functions:
#' - [filter()] — domain-aware filtering
#' - [select()] — column selection
#' - [mutate()] — add/modify variables
#'
#' @section Documentation:
#' For ecosystem architecture, see [the ecosystem guide](../survey-standards/ECOSYSTEM.md).
#'
#' @keywords internal
#' "_PACKAGE"
```

---

## Summary for All Packages

**Do this in every surveyverse package:**
1. Use `::` for all external package calls (no `@importFrom`)
2. Never manually edit `NAMESPACE` — use roxygen2
3. Run `devtools::document()` before committing code with roxygen changes
4. Run `devtools::check()` before opening PRs
5. Write `@return` on every exported function
6. Keep `@examples` runnable (no `\dontrun{}`)
7. Export user-facing functions and S7 classes only

**For package-specific details**, see the local conventions file in each package.
