# surveycore R Package Conventions

**Version:** 1.0
**Created:** February 2025
**Status:** Decided — do not re-litigate without updating this document

---

## Quick Reference

| Decision | Choice |
|----------|--------|
| `@param` verbosity | Variable — terse for simple args; fuller for non-obvious args (`nest`, `fpc`, `type`) |
| Import style | `::` everywhere; no `@importFrom` |
| `haven` placement | `Suggests` — use `attr(col, "label", exact = TRUE)` at runtime |
| `devtools::document()` | Before committing any file that changes roxygen2 content |
| `devtools::check()` | Before opening a PR |
| Export policy | User-facing functions + S7 classes |
| Re-exports | None — no pipe, no tidyselect helpers |
| Internal function docs | `@keywords internal` + `@noRd` for complex helpers; nothing for one-liners |
| `NAMESPACE` edits | Never manual — 100% generated by `devtools::document()` |
| `R CMD check` note tolerance | ≤2 pre-approved notes ("no visible binding", "CRAN incoming feasibility") |
| NSE "no visible binding" notes | Accept — pre-approved, zero maintenance |
| `--as-cran` flag | CI only; local `check()` without it |
| Version pinning | Minimum versions only (`cli (>= 3.6.0)`) |
| `@examples` | All runnable — no `\dontrun{}`; use smaller inline data if slow |
| `@seealso` | Entry points only (`as_survey()`, `as_survey_rep()`, `as_survey_twophase()`) |
| `@return` | Required on all exported functions |
| `@family` | By functional group (`constructors`, `metadata`, `validators`, etc.) |

---

## 1. Documentation (Roxygen2)

### `@param` verbosity: variable by complexity

Write `@param` descriptions proportional to how non-obvious the argument is.

**Terse** (one sentence) for simple, self-evident arguments:
```r
#' @param data A data.frame containing the survey responses.
#' @param label A character string. The variable label to assign.
#' @param ... Additional arguments (currently unused).
```

**Fuller** for arguments with non-obvious behavior, constraints, or interactions:
```r
#' @param nest Logical. If `TRUE`, PSU IDs are treated as nested within
#'   strata — i.e., the same PSU ID value in two different strata refers to
#'   two distinct PSUs. Set `nest = TRUE` when PSU IDs are not globally unique
#'   (e.g., NHANES uses IDs 1–30 within each stratum). Requires `strata` to
#'   be specified. Default `FALSE`.

#' @param fpc <[`tidy-select`][tidyselect::language]> Finite population
#'   correction column. Supply either the total population size (an integer
#'   column, e.g., stratum population size) or the sampling fraction (a
#'   numeric column between 0 and 1). Cannot contain `NA`. If `NULL`, the
#'   design assumes sampling from an infinite population. Default `NULL`.

#' @param type The replicate weight method. One of `"JK1"` (unstratified
#'   jackknife), `"JK2"` (stratified jackknife), `"JKn"` (jackknife with
#'   varying replication counts), `"BRR"` (balanced repeated replication),
#'   `"Fay"` (Fay's BRR), or `"bootstrap"`. Each type implies different
#'   constraints on `repweights` structure — see Details.
```

Arguments that always get fuller treatment regardless of apparent simplicity:
- Any argument that interacts with another argument (mutual exclusion, dependency)
- Arguments where `NULL` has non-obvious behavior
- Arguments that accept multiple interpretations (e.g., population size OR sampling fraction)
- Arguments with valid value constraints (positive only, no NAs, must be between 0 and 1)

### `@return` required on all exports

`R CMD check --as-cran` warns on missing `@return` for exported functions. Write terse returns for obvious cases:

```r
#' @return A `survey_taylor` object.
#' @return A `survey_replicate` object.
#' @return A character string, or `NULL` if no label has been set.
#' @return The modified survey object, invisibly.  # for setters
#' @return `invisible(TRUE)`.  # for validators
```

### `@examples`: all runnable

Every example must run successfully during `R CMD check`. Do not use `\dontrun{}` except for examples that genuinely require external resources not available during check (e.g., a live database connection). `\donttest{}` is acceptable for examples that are genuinely slow but available — use it sparingly.

If an example is slow, the fix is a smaller inline dataset, not a `\dontrun{}` wrapper:

```r
#' @examples
#' # Using a package dataset
#' d <- as_survey(nhanes_2017, ids = sdmvpsu, weights = wtmec2yr, strata = sdmvstra)
#'
#' # Using inline data (preferred for faster examples)
#' df <- data.frame(id = 1:10, y = rnorm(10), w = runif(10, 0.5, 2))
#' d  <- as_survey(df, weights = w)
```

### `@seealso`: entry points only

Only `as_survey()`, `as_survey_rep()`, and `as_survey_twophase()` carry `@seealso`. They point to each other and to key related functions:

```r
# In as_survey() roxygen block
#' @seealso
#'   [as_survey_rep()] for replicate-weight designs,
#'   [as_survey_twophase()] for two-phase designs,
#'   [update_design()] to modify an existing design,
#'   [extract_var_label()] to retrieve variable labels
```

Getters, setters, validators, and print methods do not carry `@seealso`.

### `@family` grouping tags

Add one `@family` tag per exported function. Groups are:

| `@family` tag | Functions |
|---------------|-----------|
| `@family constructors` | `as_survey()`, `as_survey_rep()`, `as_survey_twophase()` |
| `@family metadata` | `extract_var_label()`, `extract_val_labels()`, `set_var_label()`, `set_variable_labels()`, `set_val_labels()`, `set_value_labels()`, etc. |
| `@family validators` | Internal validator helpers (if exported) |
| `@family update` | `update_design()` |
| `@family conversion` | `as_svydesign()`, `from_svydesign()`, `as_tbl_svy()`, `from_tbl_svy()` |

```r
#' @family constructors
as_survey <- function(data, ...) { ... }
```

pkgdown uses `@family` to generate "See also" sections automatically. These are set up for Phase 0 completion when pkgdown is configured.

### Internal function documentation

| Helper complexity | Documentation |
|-------------------|---------------|
| Obvious one-liner | No roxygen at all |
| Complex enough to need explanation | `@keywords internal` + `@noRd` |

```r
# One-liner — no roxygen needed
.get_design_vars_flat <- function(design) {
  c(design@variables$ids, design@variables$weights,
    design@variables$strata, design@variables$fpc)
}

# Complex helper — document but suppress .Rd
#' Resolve tidy-select expression against data frame columns
#'
#' @param expr An unevaluated expression (from [rlang::enquo()]).
#' @param data A data.frame to select against.
#' @return A character vector of resolved column names, or `NULL` if expr is NULL.
#' @keywords internal
#' @noRd
.resolve_tidy_select <- function(expr, data) { ... }
```

---

## 2. NAMESPACE & Exports

### Export policy: user-facing functions + S7 classes

Both user-facing functions AND S7 class objects are exported. S7 classes are part of the documented API — users writing extensions or performing `S7::inherits()` checks need them.

```r
# User-facing functions — export with @export
#' @export
as_survey <- function(data, ...) { ... }

# S7 classes — export with @export in the class definition file
#' @export
survey_taylor <- S7::new_class("survey_taylor", ...)
```

Unexported (no `@export`):
- All `.`-prefixed helpers (``.validate_weights()``, `.resolve_tidy_select()`)
- Internal S7 generics not part of the public API

### `::` everywhere — no `@importFrom`

All external package functions are called with `::`. No `@importFrom` in any source file.

```r
# Correct
wt_col   <- rlang::enquo(weights)
var_name <- rlang::as_name(wt_col)
cli::cli_abort(c("x" = "..."), class = "surveycore_error_...")
vars     <- tidyselect::eval_select(wt_col, data)

# Wrong
enquo(weights)         # requires @importFrom rlang enquo
cli_abort(c("x" = "..."))  # requires @importFrom cli cli_abort
```

Rationale: `::` is maximally explicit about where every function comes from. This codebase is not performance-sensitive at the R level (variance estimation is the bottleneck). Namespace lookup overhead is negligible.

### No re-exports

surveycore does not re-export the pipe or tidyselect helpers. Users who need `|>` have R ≥ 4.1.0. Users who need `everything()` or `starts_with()` have tidyverse or tidyselect loaded.

Do not add `@importFrom magrittr %>%` or `@importFrom tidyselect everything` with `@export`.

### `haven` in `Suggests`, not `Imports`

Haven label attributes are extracted with base R, not haven functions:

```r
# Correct — no haven import needed
label  <- attr(col, "label",  exact = TRUE)
labels <- attr(col, "labels", exact = TRUE)

# Wrong — requires haven at runtime
label  <- haven::var_label(col)
```

`haven` appears in `Suggests` only. It is needed in `data-raw/` scripts (to read `.xpt` files) but never at package runtime. `skip_if_not_installed("haven")` is required for any test that writes/reads `.xpt` format.

### `NAMESPACE` is never manually edited

`NAMESPACE` carries the `# Generated by roxygen2: do not edit by hand` header. Treat it as a build artifact. Every export, import, and S3 method registration must come from a roxygen2 tag. If roxygen2 can't express something, find a roxygen2 solution — do not work around it with manual edits that the next `devtools::document()` run will silently overwrite.

---

## 3. Package Check Hygiene

### `R CMD check` note tolerance

PRs must pass with **0 errors, 0 warnings, ≤2 notes**. The following two notes are pre-approved and do not block merging:

| Note text | Why it appears | Why it's accepted |
|-----------|----------------|-------------------|
| `no visible binding for global variable 'X'` | Tidy-select bare names in examples and tests | Universal in tidy packages; suppressing with `globalVariables()` adds noise |
| `checking CRAN incoming feasibility` | Package not yet on CRAN | Informational; disappears after first CRAN submission |

Any note other than these two is treated as a bug and blocks the PR.

### NSE "no visible binding" notes: accept, don't suppress

Do not add `utils::globalVariables()` to suppress NSE notes. Do not change examples to use `.data$var` syntax (it misrepresents the bare-name API).

The note is pre-approved. Accept it and move on.

### `devtools::check()` cadence

**Local development:**
```r
devtools::check()  # No --as-cran flag; fast feedback during development
```

**CI (`.github/workflows/R-CMD-check.yaml`):**
```yaml
- uses: r-lib/actions/check-r-package@v2
  with:
    args: 'c("--as-cran", "--no-manual")'
```

Switch local checks to `--as-cran` in Phase 3 (Polish) when CRAN submission is the active goal.

### `devtools::document()` cadence

Run `devtools::document()` before committing any file that touches roxygen2 content — that means any `.R` file in `R/` that has `#'` comments, or `DESCRIPTION` changes that affect package-level docs.

The NAMESPACE and `man/` files are committed to version control and must be in sync with source. A PR where `NAMESPACE` is out of date with the roxygen2 annotations fails `R CMD check`.

```r
# Before committing changes to R/03-constructors.R:
devtools::document()
git add NAMESPACE man/as_survey.Rd
git commit -m "docs(constructors): update as_survey roxygen"
```

### `DESCRIPTION` version pinning: minimum versions only

Specify lower bounds for all `Imports` dependencies. Set the bound to the oldest version where the required feature exists. Add a comment explaining what the minimum provides:

```r
Imports:
    cli (>= 3.6.0),      # cli_abort() with class= argument
    rlang (>= 1.1.0),    # rlang::check_required()
    S7 (>= 0.1.0),       # S7::new_class(), S7::method()
    tidyselect (>= 1.2.0) # tidyselect::eval_select()
Suggests:
    haven (>= 2.5.0),
    survey (>= 4.2.0),
    srvyr (>= 1.2.0),
    testthat (>= 3.0.0),
    devtools,
    knitr,
    rmarkdown
```

Update a minimum version bound when a new minimum-required feature from that package is used. Add a comment explaining the new minimum.

Do not use exact version pins (`==`). They are rejected by CRAN and too fragile for a development package.
