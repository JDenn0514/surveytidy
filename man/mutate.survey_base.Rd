% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/mutate.R
\name{mutate.survey_base}
\alias{mutate.survey_base}
\title{Create, modify, and delete columns of a survey design object}
\usage{
mutate.survey_base(
  .data,
  ...,
  .by = NULL,
  .keep = c("all", "used", "unused", "none"),
  .before = NULL,
  .after = NULL
)
}
\arguments{
\item{.data}{A \code{\link[surveycore:survey_base]{survey_base}} object.}

\item{...}{<\code{\link[rlang:args_data_masking]{data-masking}}> Name-value pairs.
The name gives the output column name; the value is an expression
evaluated against the survey data. Use \code{NULL} to delete a non-design
column.}

\item{.by}{Not used directly. Set grouping with \code{\link[=group_by]{group_by()}} instead.
When \verb{@groups} is non-empty and \code{.by} is \code{NULL} (the default), the
active groups are applied automatically.}

\item{.keep}{Which columns to retain. One of \code{"all"} (default), \code{"used"},
\code{"unused"}, or \code{"none"}. Design variables are always re-attached
regardless of this argument.}

\item{.before, .after}{<\code{\link[tidyselect:language]{tidy-select}}> Optionally
position new columns before or after an existing one.}
}
\value{
An object of the same type as \code{.data} with the following properties:
\itemize{
\item Rows are not added or removed.
\item Columns are retained, modified, or removed per \code{...} and \code{.keep}.
\item Design variables (weights, strata, PSUs) are always present.
\item Groups and survey design attributes are preserved.
}
}
\description{
\code{mutate()} adds new columns or modifies existing ones while preserving the
survey design structure required for valid variance estimation. It delegates
column computation to \code{dplyr::mutate()} on the underlying data.

Use \code{NULL} as a value to delete a column. Design variables (weights,
strata, PSUs) cannot be deleted this way — they are always preserved.
}
\details{
\subsection{Design variable modification}{

If the left-hand side of a mutation names a design variable (e.g.,
\code{mutate(d, wt = wt * 2)}), a \code{surveytidy_warning_mutate_design_var}
warning is issued. Detection is name-based: \code{across()} calls that happen
to modify design variables will \strong{not} trigger the warning.
}

\subsection{\code{.keep} and design variables}{

Design variables (weights, strata, PSUs, FPC, replicate weights, and the
domain column) are always preserved in the output, regardless of \code{.keep}.
This ensures variance estimation remains valid even when \code{.keep = "none"}.
}

\subsection{Grouped mutate}{

Grouping set by \code{\link[=group_by]{group_by()}} is respected automatically — leave \code{.by = NULL} (the default) and mutate expressions will compute within groups.
The \code{.by} argument is not used directly.
}

\subsection{Useful mutate functions}{
\itemize{
\item Arithmetic: \code{+}, \code{-}, \code{*}, \code{/}, \code{^}, \code{\%\%}, \code{\%/\%}
\item Rounding: \code{\link[=round]{round()}}, \code{\link[=floor]{floor()}}, \code{\link[=ceiling]{ceiling()}}, \code{\link[=trunc]{trunc()}}
\item Ranking: \code{\link[dplyr:row_number]{dplyr::dense_rank()}}, \code{\link[dplyr:row_number]{dplyr::min_rank()}}, \code{\link[dplyr:row_number]{dplyr::row_number()}}
\item Cumulative: \code{\link[=cumsum]{cumsum()}}, \code{\link[=cummax]{cummax()}}, \code{\link[=cummin]{cummin()}}, \code{\link[dplyr:cumall]{dplyr::cummean()}}
\item Conditional: \code{\link[dplyr:if_else]{dplyr::if_else()}}, \code{\link[dplyr:case-and-replace-when]{dplyr::case_when()}}, \code{\link[dplyr:case_match]{dplyr::case_match()}}
\item Missing values: \code{\link[dplyr:na_if]{dplyr::na_if()}}, \code{\link[dplyr:coalesce]{dplyr::coalesce()}}
}
}
}
\examples{
library(surveytidy)
library(surveycore)
d <- as_survey(pew_npors_2025, weights = weight, strata = stratum)

# Add a new column
mutate(d, college_grad = educcat == 1)

# Conditional recoding
mutate(d, college = dplyr::if_else(educcat == 1, "college+", "non-college"))

# Grouped mutate — within-group mean centring
d |>
  group_by(gender) |>
  mutate(econ_centred = econ1mod - mean(econ1mod, na.rm = TRUE))

# .keep = "none" keeps only new columns plus design vars (always preserved)
mutate(d, college = dplyr::if_else(educcat == 1, "college+", "non-college"),
  .keep = "none")

}
\seealso{
\code{\link[=rename]{rename()}} to rename columns, \code{\link[=select]{select()}} to drop columns

Other modification: 
\code{\link{rename.survey_base}()}
}
\concept{modification}
